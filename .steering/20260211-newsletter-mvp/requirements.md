# 要求内容

## 概要

AI Curated Newsletter の MVP Phase 1 として、RSS/Atom収集から通知までの全コア機能を実装します。週2〜3回の定期実行で、技術記事を自動収集・判定し、最大12件に厳選してメール通知するシステムを構築します。

## 背景

技術ニュース・テックブログは情報過多で、毎日追うのは非現実的です。本システムは、広範囲に収集し、ユーザーの関心に照らして「本当に読む価値がある」ものだけを抽出することで、判断コストをゼロにします。

MVP Phase 1では、以下の原則に従って実装します：
- **出力最小主義**: 各回最大12件（絶対制約）
- **LLM判断器**: LLMは判定のみに使用（件数制御・重複排除は非LLMロジック）
- **再判定禁止**: 同一URLは一度判定したらキャッシュし、再判定しない
- **TooMuch原則**: 個人開発なので、複雑さ・コスト・運用負荷を最小限に保つ

## 実装対象の機能

### 1. RSS/Atom収集
- 複数のRSSフィードから記事情報（URL、タイトル、公開日時、ソース名、概要）を取得
- 本文全文は取得せず、概要のみ（最大800文字）
- ソース単位のエラーハンドリング（1つのソース失敗で全体停止しない）
- 収集元マスタ（`config/sources.json`）から設定を読み込み

### 2. 正規化
- URL正規化（クエリパラメータ除去、utm_*除去、スキーム統一）
- 日時をUTC ISO8601形式に統一
- タイトル整形（前後空白除去、HTML実体参照デコード）
- 概要を最大800文字に制限

### 3. 重複排除
- 正規化されたURL単位で重複を検出
- DynamoDBキャッシュに存在するURLは再判定しない
- MVP段階では完全一致のみ（近似重複は未対応）

### 4. Buzzスコア計算（非LLM）
- 複数ソースでの出現回数をカウント
- 公開からの経過日数を計算（鮮度スコア）
- ドメイン多様性を計算
- 総合Buzzスコアを算出（0-100点）

### 5. LLM判定候補選定
- Buzzスコア + 鮮度でソート
- 上位最大150件（推奨120件）を選定
- キャッシュヒット済みURLは除外

### 6. LLM判定（Interest/Buzz）
- AWS Bedrock（Claude 3.5 Sonnet）で記事を判定
- 判定結果: `{"interest_label": "ACT_NOW | THINK | FYI | IGNORE", "buzz_label": "HIGH | MID | LOW", "confidence": 0.0~1.0, "reason": "..."}`
- 並列度5（5件ずつ並列判定）
- JSON形式崩れの場合、再試行（最大2回）→ 失敗時はIGNORE扱い
- 判定結果をDynamoDBにキャッシュ保存

### 7. 最終選定
- Interest Label順に優先順位付け（ACT_NOW > THINK > FYI > IGNORE）
- 同一ラベル内でBuzz Label、鮮度、Confidenceでソート
- 最大12件を選定
- 同一ドメイン偏り制御（同一ドメインは最大4件まで）
- 0件の場合も通知する

### 8. メール通知
- メール本文に記事一覧（タイトル、URL、Interest/Buzzラベル、理由）を含める
- サマリ統計（収集数、LLM判定数、最終通知数、実行日時）を含める
- Amazon SES経由で送信

### 9. 実行履歴保存
- DynamoDBに実行履歴を保存（PK: `RUN#yyyyww`, SK: `SUMMARY#timestamp`）
- 保存内容: 収集数、LLM判定数、最終通知数、送信結果、コスト概算、実行時間
- run_id単位で構造化ログを出力

### 10. EventBridge定期実行
- EventBridgeで週2〜3回のスケジュール実行を設定
- 曜日・時間は設定可能（例: 火曜09:00 UTC、金曜09:00 UTC）
- 手動実行も可能（Lambda直接実行、dry_runモードあり）

## 受け入れ条件

### 1. RSS/Atom収集
- [ ] 複数のRSSフィードから記事情報を取得できる
- [ ] 取得情報は最大800文字の概要のみで、本文全文は取得しない
- [ ] 1つのソース失敗で全体が停止せず、他のソースは収集を継続する
- [ ] 収集件数を構造化ログに記録する

### 2. 正規化
- [ ] URL正規化（クエリパラメータ除去、utm_*除去、スキーム統一）ができる
- [ ] 日時をUTC ISO8601形式に統一できる
- [ ] タイトルを整形（前後空白除去、HTML実体参照デコード）できる
- [ ] 概要を最大800文字に制限できる

### 3. 重複排除
- [ ] 正規化されたURL単位で重複を検出できる
- [ ] DynamoDBキャッシュに存在するURLは再判定しない
- [ ] MVP段階では完全一致のみ（近似重複は未対応）

### 4. Buzzスコア計算
- [ ] 複数ソースでの出現回数をカウントできる
- [ ] 公開からの経過日数を計算できる（鮮度スコア）
- [ ] ドメイン多様性を計算できる
- [ ] 総合Buzzスコアを算出できる

### 5. LLM判定候補選定
- [ ] Buzzスコア + 鮮度でソートできる
- [ ] 上位最大150件を選定できる
- [ ] キャッシュヒット済みURLは除外できる
- [ ] 選定件数をログに記録できる

### 6. LLM判定
- [ ] 関心プロファイルを元に判定できる
- [ ] 判定結果は固定フォーマット（JSON）で取得できる
- [ ] JSON形式崩れの場合、再試行（最大2回）→ 失敗時はIGNORE扱い
- [ ] 判定結果をDynamoDBにキャッシュできる

### 7. 最終選定
- [ ] Interest Label順に優先順位付けできる
- [ ] 同一ラベル内でBuzz Label、鮮度、Confidenceでソートできる
- [ ] 最大12件を選定できる
- [ ] 同一ドメイン偏り制御ができる
- [ ] 0件の場合も通知する

### 8. メール通知
- [ ] メール本文に記事一覧を含める
- [ ] サマリ統計を含める
- [ ] 0件の場合も通知する
- [ ] SES経由で送信できる

### 9. 実行履歴保存
- [ ] DynamoDBに実行履歴を保存できる
- [ ] 保存内容: 収集数、LLM判定数、最終通知数、送信結果、コスト概算、実行時間
- [ ] run_id単位で構造化ログを出力できる

### 10. EventBridge定期実行
- [ ] EventBridgeで週2〜3回のスケジュール実行を設定できる
- [ ] 曜日・時間は設定可能
- [ ] 手動実行も可能（dry_runモードあり）

## 成功指標

- 全体実行時間: 10分以内
- LLMコスト: 1回あたり$0.50以下
- 実行成功率: 95%以上
- テストカバレッジ: 80%以上（サービス層）

## スコープ外

以下はPhase 2以降で実装します:

- フィードバック機能（通知記事の評価収集）
- 近似重複排除（Embedding + ベクトル検索）
- X（旧Twitter）対応
- Step Functions化（処理時間が12分を超える場合）
- 管理UI（収集元追加・削除）
- マルチユーザー対応

## 参照ドキュメント

- `docs/product-requirements.md` - プロダクト要求定義書
- `docs/functional-design.md` - 機能設計書
- `docs/architecture.md` - アーキテクチャ設計書
- `docs/repository-structure.md` - リポジトリ構造定義書
- `docs/development-guidelines.md` - 開発ガイドライン
- `docs/glossary.md` - 用語集
