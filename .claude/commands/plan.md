---
description: issue や指示からステアリングファイルを対話的に作成
argument-hint: 機能名 または GitHub issue URL
---

# 機能計画 (/plan)

**目的:** issue や指示からステアリングファイルを作成し、実装計画を立てる

**引数:** 機能名 または GitHub issue URL (例: `/plan ユーザープロフィール編集` または `/plan https://github.com/owner/repo/issues/123`)

**出力:** `.steering/[日付]-[機能名]/` ディレクトリと3つのファイル (requirements.md, design.md, tasklist.md)

---

## ステップ1: 準備とコンテキスト設定

1. **引数を解析する:**
   - **GitHub issue URL の場合:**
     - パターン: `https://github.com/{owner}/{repo}/issues/{number}`
     - `gh issue view {number} --json title,body,labels --jq '{title: .title, body: .body, labels: [.labels[].name]}'` で issue 内容を取得
     - タイトルから機能名を生成:
       - 小文字化
       - スペースとスラッシュをハイフンに変換
       - 特殊文字を除去
       - 例: "ユーザー プロフィール/編集" → "ユーザー-プロフィール-編集"
   - **機能名の場合:**
     - そのまま機能名として使用

2. **現在のタスクコンテキストを確立する:**
   - 機能名: `[引数または issue タイトルから生成した機能名]`
   - 日付: `[現在の日付を YYYYMMDD 形式で取得]`
   - ステアリングディレクトリパス: `.steering/[日付]-[機能名]/`
   - issue URL: `[引数が URL の場合は保持]`
   - issue 番号: `[URL から抽出、または null]`

3. **ステアリングディレクトリを作成する:**
   - 上記パスでディレクトリを作成

4. **3つの空ファイルを作成する:**
   - `[ステアリングディレクトリパス]/requirements.md`
   - `[ステアリングディレクトリパス]/design.md`
   - `[ステアリングディレクトリパス]/tasklist.md`

## ステップ2: プロジェクト理解

1. `CLAUDE.md` を読み、プロジェクトの全体像を把握する
2. `docs/` ディレクトリ内の永続ドキュメントを確認し、関連する設計思想やアーキテクチャを理解する

## ステップ3: 既存パターンの調査

1. Grep ツールを使用し、機能名に関連するキーワードでソースコード (`src/`) を検索する
   ```
   Grep('[機能に関連するキーワード]', path='src/', output_mode='files_with_matches')
   ```
2. 検索結果を分析し、既存の実装パターン、命名規則、コンポーネントの利用方法を特定する

## ステップ4: 要件の明確化 (対話的確認)

1. **要件の分析:**
   - issue 本文または指示内容を分析
   - 不明点、曖昧な点、複数の解釈が可能な点をリストアップ

2. **不明点がある場合:**
   - `AskUserQuestion` ツールを使用してユーザーに確認
   - 技術的な選択肢がある場合は、候補を複数挙げて推奨度を示す
   - 例:
     ```
     質問: 「認証方式をどれにしますか?」
     選択肢:
     - JWT (推奨: ステートレスで拡張性が高い)
     - セッションベース (シンプルだがサーバー負荷が高い)
     ```

3. **要件が明確な場合:**
   - このステップをスキップして次へ

## ステップ5: 計画フェーズ (ステアリングファイル生成)

1. **`Skill('steering')` を計画モードで実行:**
   - ステップ1で作成した3つのファイルの内容を生成
   - `requirements.md`, `design.md`, `tasklist.md`

2. **requirements.md に issue との紐付けを追加:**
   - issue URL が存在する場合、以下のセクションを冒頭に追加:
     ```markdown
     ## GitHub Issue
     [issue URL]

     ## issue 内容
     - タイトル: [issue.title]
     - 本文: [issue.body]
     - ラベル: [issue.labels]
     ```

## ステップ6: 完了確認

1. 生成されたステアリングファイルの内容をユーザーに提示

2. 以下のメッセージを表示:
   ```
   ステアリングファイルの作成が完了しました。

   作成されたファイル:
   - [ステアリングディレクトリパス]/requirements.md
   - [ステアリングディレクトリパス]/design.md
   - [ステアリングディレクトリパス]/tasklist.md

   内容を確認してください。

   実装を開始する場合は以下のコマンドを実行してください:
   `/implement [ステアリングディレクトリパス]`
   ```

---

## 注意事項

- 不明点がある場合は、必ず `AskUserQuestion` で確認すること
- 仮定を置かず、ユーザーの意図を正確に把握すること
- issue との紐付けは必須 (issue URL が引数の場合)
- ステアリングファイルの内容は、後続の `/implement` コマンドで使用される
- このコマンドは対話的に動作し、ユーザーの承認を得ながら進める
